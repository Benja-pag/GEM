{% extends 'base/base.html' %}
{% load static %}
{% load evaluacion_tags %}
{% load horario_tags %}

{% block title %}Detalles de {{ asignatura.asignatura.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/system_messages.css' %}">
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        --card-shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
        --border-radius: 15px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
    .container { max-width: 1400px; }
    .asignatura-header { background: var(--primary-gradient); border-radius: var(--border-radius); padding: 2rem; margin-bottom: 2rem; box-shadow: var(--card-shadow); position: relative; overflow: hidden; }
    .asignatura-header::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(180deg); } }
    .asignatura-icon { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); }
    .nav-tabs { border: none; background: white; border-radius: var(--border-radius); padding: 0.5rem; box-shadow: var(--card-shadow); margin-bottom: 2rem; }
    .nav-tabs .nav-link { border: none; border-radius: 10px; margin: 0 0.25rem; padding: 0.75rem 1.5rem; color: #6c757d; font-weight: 500; transition: var(--transition); position: relative; overflow: hidden; }
    .nav-tabs .nav-link::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: var(--primary-gradient); transition: var(--transition); z-index: -1; }
    .nav-tabs .nav-link:hover::before, .nav-tabs .nav-link.active::before { left: 0; }
    .nav-tabs .nav-link:hover, .nav-tabs .nav-link.active { color: white; transform: translateY(-2px); }
    .card { border: none; border-radius: var(--border-radius); box-shadow: var(--card-shadow); transition: var(--transition); overflow: hidden; }
    .card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
    .card-header { background: var(--primary-gradient); color: white; border: none; padding: 1.5rem; }
    .stats-card { background: white; border-radius: var(--border-radius); padding: 1.5rem; text-align: center; box-shadow: var(--card-shadow); transition: var(--transition); position: relative; overflow: hidden; }
    .stats-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-gradient); }
    .stats-card:hover { transform: translateY(-3px); box-shadow: var(--card-shadow-hover); }
    .stats-number { font-size: 2.5rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .progress { height: 12px; border-radius: 10px; background: #e9ecef; overflow: hidden; }
    .progress-bar { background: var(--success-gradient); border-radius: 10px; transition: width 1s ease-in-out; }
    .badge { padding: 0.5rem 1rem; border-radius: 20px; font-weight: 500; font-size: 0.85rem; }
    .badge-primary { background: var(--primary-gradient); }
    .badge-success { background: var(--success-gradient); }
    .badge-warning { background: var(--warning-gradient); }
    .badge-info { background: var(--info-gradient); }
    .btn { border-radius: 25px; padding: 0.75rem 1.5rem; font-weight: 500; transition: var(--transition); border: none; position: relative; overflow: hidden; }
    .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
    .btn:hover::before { left: 100%; }
    .btn-primary { background: var(--primary-gradient); }
    .btn-success { background: var(--success-gradient); }
    .btn-warning { background: var(--warning-gradient); }
    .list-group-item { border: none; border-radius: 10px; margin-bottom: 0.5rem; padding: 1rem; transition: var(--transition); background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .list-group-item:hover { transform: translateX(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .material-card { background: white; border-radius: var(--border-radius); padding: 1.5rem; text-align: center; transition: var(--transition); position: relative; overflow: hidden; }
    .material-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--primary-gradient); opacity: 0; transition: var(--transition); z-index: -1; }
    .material-card:hover::before { opacity: 0.05; }
    .material-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
    .material-icon { font-size: 3rem; margin-bottom: 1rem; transition: var(--transition); }
    .material-card:hover .material-icon { transform: scale(1.1); }
    .form-control { border-radius: 10px; border: 2px solid #e9ecef; padding: 0.75rem 1rem; transition: var(--transition); }
    .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
    .loading { opacity: 0.7; pointer-events: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .asignatura-header { padding: 1.5rem; } .nav-tabs .nav-link { padding: 0.5rem 1rem; font-size: 0.9rem; } .stats-number { font-size: 2rem; } }
    ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } ::-webkit-scrollbar-thumb { background: var(--primary-gradient); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); }
    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .estudiantes-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 8px 8px 0 0;
    }
    
    .table th {
        border-top: none;
        border-bottom: 2px solid #dee2e6;
        background-color: #f8f9fa;
        padding: 1rem;
    }
    
    .table td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    .curso-badge {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background-color: #e9ecef;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-4">
    <!-- Header mejorado de la asignatura -->
    <div class="asignatura-header text-white">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="asignatura-icon me-3">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                    <div>
                        <h1 class="mb-1 fw-bold" id="asignatura-nombre">{{ asignatura.asignatura.nombre }}</h1>
                        <p class="mb-0 opacity-75" id="asignatura-docente">
                            <i class="fas fa-chalkboard-teacher me-2"></i>
                            Prof. {{ asignatura.docente.usuario.nombre }} {{ asignatura.docente.usuario.apellido_paterno }}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-hashtag me-2"></i>
                            <span class="fw-bold" id="asignatura-codigo">{{ asignatura.codigo }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-envelope me-2"></i>
                            <span>{{ asignatura.docente.usuario.email }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-graduate me-2"></i>
                            <span>{{ estudiantes|length }} estudiantes</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="stats-card bg-white bg-opacity-10 backdrop-blur">
                    <div class="stats-number text-white">{{ clases|length }}</div>
                    <small class="text-white-75">Clases Totales</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs de navegaciÃ³n mejorados -->
    <ul class="nav nav-tabs" id="asignaturaTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                <i class="fas fa-info-circle me-2"></i>General
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="estudiantes-tab" data-bs-toggle="tab" data-bs-target="#estudiantes" type="button">
                <i class="fas fa-user-friends me-2"></i>Estudiantes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="horario-tab" data-bs-toggle="tab" data-bs-target="#horario" type="button">
                <i class="fas fa-calendar-alt me-2"></i>Horario
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas" type="button">
                <i class="fas fa-graduation-cap me-2"></i>Notas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="asistencia-tab" data-bs-toggle="tab" data-bs-target="#asistencia" type="button">
                <i class="fas fa-user-check me-2"></i>Asistencia
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comunicacion-tab" data-bs-toggle="tab" data-bs-target="#comunicacion" type="button">
                <i class="fas fa-comments me-2"></i>ComunicaciÃ³n
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="foro-tab" data-bs-toggle="tab" data-bs-target="#foro" type="button">
                <i class="fas fa-users me-2"></i>Foro
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestaÃ±as -->
    <div class="tab-content" id="asignaturaTabsContent">
        <!-- PestaÃ±a General -->
        <div class="tab-pane fade show active fade-in" id="general">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line me-2"></i>EstadÃ­sticas del Curso
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-number text-success">{{ estadisticas.porcentaje_asistencia }}%</div>
                                        <small class="text-muted">Asistencia Promedio</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-number text-primary">{{ estadisticas.promedio_general }}</div>
                                        <small class="text-muted">Promedio General</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-number text-warning">{{ estadisticas.porcentaje_avance }}%</div>
                                        <small class="text-muted">Avance del Curso</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">Progreso del curso</span>
                                    <span class="text-muted">{{ estadisticas.porcentaje_avance }}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ estadisticas.porcentaje_avance }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar me-2"></i>PrÃ³ximas Actividades
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if proximas_actividades %}
                            <div class="list-group">
                                {% for actividad in proximas_actividades %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between mb-1">
                                        <h6 class="mb-1">
                                            {% if actividad.tipo == 'EvaluaciÃ³n' %}
                                            <i class="fas fa-clipboard-check text-primary me-2"></i>
                                            {% else %}
                                            <i class="fas fa-calendar-day text-success me-2"></i>
                                            {% endif %}
                                            {{ actividad.titulo }}
                                        </h6>
                                        <small class="text-muted">{{ actividad.asignatura }}</small>
                                    </div>
                                    <p class="mb-1">{{ actividad.descripcion|default:"Sin descripciÃ³n" }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">{{ actividad.fecha|date:"d/m/Y" }}</small>
                                        <span class="badge {% if actividad.dias_restantes == 0 %}bg-danger{% elif actividad.dias_restantes <= 2 %}bg-warning{% else %}bg-info{% endif %}">
                                            {% if actividad.dias_restantes == 0 %}
                                            Hoy
                                            {% elif actividad.dias_restantes == 1 %}
                                            MaÃ±ana
                                            {% else %}
                                            En {{ actividad.dias_restantes }} dÃ­as
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted text-center mb-0">No hay actividades programadas para los prÃ³ximos 7 dÃ­as</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PestaÃ±a Estudiantes -->
        <div class="tab-pane fade fade-in" id="estudiantes">
            <div class="card">
                <div class="estudiantes-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-friends me-2"></i>Estudiantes Inscritos
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if estudiantes %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 45%">
                                            <i class="fas fa-user me-2"></i>Nombre Completo
                                        </th>
                                        <th style="width: 25%">
                                            <i class="fas fa-id-card me-2"></i>RUT
                                        </th>
                                        <th style="width: 30%">
                                            <i class="fas fa-envelope me-2"></i>Correo ElectrÃ³nico
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for estudiante in estudiantes %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="student-avatar me-3">
                                                    <i class="fas fa-user-graduate"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ estudiante.usuario.nombre }} {{ estudiante.usuario.apellido_paterno }} {{ estudiante.usuario.apellido_materno }}</div>
                                                    <span class="curso-badge">{{ estudiante.curso }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ estudiante.usuario.rut }}-{{ estudiante.usuario.div }}</td>
                                        <td>{{ estudiante.usuario.correo }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-4">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>No hay estudiantes inscritos en esta asignatura.
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PestaÃ±a Horario -->
        <div class="tab-pane fade fade-in" id="horario">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Horario de Clases
                    </h5>
                </div>
                <div class="card-body">
                    {% if clases %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-calendar-day me-2"></i>DÃ­a</th>
                                        <th><i class="fas fa-clock me-2"></i>Horario</th>
                                        <th><i class="fas fa-door-open me-2"></i>Sala</th>
                                        <th><i class="fas fa-users me-2"></i>Curso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for clase in clases %}
                                    <tr>
                                        <td><span class="badge badge-primary">{{ clase.fecha|dia_semana }}</span></td>
                                        <td><i class="fas fa-clock me-2"></i>{{ clase.horario }}</td>
                                        <td>{{ clase.sala }}</td>
                                        <td><span class="badge badge-primary">{{ clase.curso }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay clases registradas para esta asignatura.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PestaÃ±a Notas -->
        <div class="tab-pane fade fade-in" id="notas">
            <div class="row align-items-stretch" style="min-height: 600px;">
                <!-- Columna principal con las pestaÃ±as de notas -->
                <div class="col-lg-8 d-flex flex-column" style="min-height: 600px;">
                    <!-- MenÃº de GestiÃ³n de Notas -->
                    <div class="card mb-4 flex-shrink-0">
                        <div class="card-body p-0">
                            <ul class="nav nav-pills nav-fill p-2" id="notasSubMenu" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" 
                                            id="evaluaciones-base-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#evaluaciones-base" 
                                            type="button" 
                                            role="tab">
                                        <i class="fas fa-clipboard-list me-2"></i>Evaluaciones Base
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" 
                                            id="evaluaciones-creadas-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#evaluaciones-creadas" 
                                            type="button" 
                                            role="tab">
                                        <i class="fas fa-calendar-check me-2"></i>Evaluaciones Creadas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" 
                                            id="notas-alumnos-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#notas-alumnos" 
                                            type="button" 
                                            role="tab">
                                        <i class="fas fa-graduation-cap me-2"></i>Notas de Alumnos
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!-- Contenido de las subpestaÃ±as -->
                    <div class="tab-content flex-grow-1" id="notasSubContent" style="min-height: 400px;">
                        <!-- SubpestaÃ±a Evaluaciones Base -->
                        <div class="tab-pane fade show active" id="evaluaciones-base" role="tabpanel">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-gradient-primary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-clipboard-list me-2"></i>Evaluaciones Base
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- BotÃ³n para Generar EvaluaciÃ³n Base -->
                                    <div class="mb-4">
                                        <button class="btn btn-primary" id="btn-generar-evaluacion-base">
                                            <i class="fas fa-plus me-2"></i>Generar EvaluaciÃ³n Base
                                        </button>
                                    </div>

                                    <!-- Lista de Evaluaciones Base -->
                                    <div class="mb-4">
                                        <h6 class="text-muted mb-3">Evaluaciones Base Disponibles</h6>
                                        <div id="lista-evaluaciones-base" style="max-height: 350px; overflow-y: auto;">
                                            <!-- Las evaluaciones base se cargarÃ¡n dinÃ¡micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SubpestaÃ±a Evaluaciones Creadas -->
                        <div class="tab-pane fade" id="evaluaciones-creadas" role="tabpanel">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-gradient-success text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-calendar-check me-2"></i>Evaluaciones Creadas
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Lista de Evaluaciones Creadas -->
                                    <div class="mb-4">
                                        <h6 class="text-muted mb-3">Evaluaciones EspecÃ­ficas Creadas</h6>
                                        <div id="lista-evaluaciones-creadas" style="max-height: 350px; overflow-y: auto;">
                                            <!-- Las evaluaciones creadas se cargarÃ¡n dinÃ¡micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SubpestaÃ±a Notas de Alumnos -->
                        <div class="tab-pane fade" id="notas-alumnos" role="tabpanel">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-gradient-warning text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-graduation-cap me-2"></i>Notas de Alumnos
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="tabla-notas">
                                        <!-- Las notas se cargarÃ¡n dinÃ¡micamente -->
                                        <div class="text-center py-4">
                                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">Selecciona una evaluaciÃ³n para ver las notas</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Panel de Chat IA - Siempre visible -->
                <div class="col-lg-4 d-flex flex-column" style="min-height: 600px;">
                    <div class="card border-0 shadow-sm mb-4 flex-grow-1 d-flex flex-column" style="height: 100%;">
                        <div class="card-header bg-gradient-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-robot me-2"></i>Asistente IA
                            </h5>
                        </div>
                        <div class="card-body d-flex flex-column" style="flex: 1 1 auto;">
                            <!-- Ãrea de Chat -->
                            <div class="chat-container mb-3" style="height: 400px; overflow-y: auto;">
                                <div id="chat-messages" class="mb-3">
                                    <!-- Los mensajes se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
                                    <div class="chat-message ai-message mb-2">
                                        <div class="message-content bg-light p-2 rounded">
                                            <i class="fas fa-robot text-info me-2"></i>
                                            Â¡Hola! Soy tu asistente IA. Puedo ayudarte con:
                                            <ul class="mt-2 mb-0">
                                                <li>AnÃ¡lisis de rendimiento</li>
                                                <li>Sugerencias de retroalimentaciÃ³n</li>
                                                <li>Estrategias de evaluaciÃ³n</li>
                                                <li>Recomendaciones personalizadas</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ãrea de Consulta -->
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" 
                                           id="ia-consulta" 
                                           class="form-control" 
                                           placeholder="Escribe tu consulta..."
                                           aria-label="Consulta IA">
                                    <button class="btn btn-info" type="button" id="enviar-consulta">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Puedes preguntar sobre anÃ¡lisis, recomendaciones o retroalimentaciÃ³n
                                </small>
                            </div>

                            <!-- Sugerencias RÃ¡pidas -->
                            <div class="quick-suggestions mt-4">
                                <h6 class="text-muted mb-3">Sugerencias RÃ¡pidas:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-info suggestion-btn" 
                                            data-query="Analizar rendimiento general">
                                        ð AnÃ¡lisis de Rendimiento
                                    </button>
                                    <button class="btn btn-sm btn-outline-info suggestion-btn" 
                                            data-query="Sugerir retroalimentaciÃ³n para bajo rendimiento">
                                        ð¡ RetroalimentaciÃ³n
                                    </button>
                                    <button class="btn btn-sm btn-outline-info suggestion-btn" 
                                            data-query="Recomendar estrategias de evaluaciÃ³n">
                                        ð Estrategias
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PestaÃ±a Asistencia -->
        <div class="tab-pane fade" id="asistencia">
            <!-- SubmenÃº de Asistencia -->
            <div class="card mb-4">
                <div class="card-body p-0">
                    <ul class="nav nav-pills nav-fill p-2" id="asistenciaSubMenu" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" 
                                    id="registro-asistencia-tab" 
                                    data-bs-toggle="pill" 
                                    data-bs-target="#registro-asistencia" 
                                    type="button" 
                                    role="tab">
                                <i class="fas fa-clipboard-check me-2"></i>Registro de Asistencia
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    id="historial-asistencia-tab" 
                                    data-bs-toggle="pill" 
                                    data-bs-target="#historial-asistencia" 
                                    type="button" 
                                    role="tab">
                                <i class="fas fa-history me-2"></i>Historial de Asistencia
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Contenido de las subpestaÃ±as -->
            <div class="tab-content" id="asistenciaSubContent">
                <!-- SubpestaÃ±a de Registro -->
                <div class="tab-pane fade show active" id="registro-asistencia" role="tabpanel">
                    <div id="asistenciaContent">
                        <!-- El contenido del formulario se cargarÃ¡ dinÃ¡micamente aquÃ­ -->
                    </div>
                </div>

                <!-- SubpestaÃ±a de Historial -->
                <div class="tab-pane fade" id="historial-asistencia" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>Historial de Asistencia
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Filtros -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Mes</label>
                                    <select class="form-select" id="mes-filtro">
                                        <option value="">Todos los meses</option>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="estado-filtro">
                                        <option value="">Todos los estados</option>
                                        <option value="presente">Presente</option>
                                        <option value="ausente">Ausente</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estudiante</label>
                                    <select class="form-select" id="estudiante-filtro">
                                        <option value="">Todos los estudiantes</option>
                                        {% for estudiante in estudiantes %}
                                        <option value="{{ estudiante.usuario.auth_user_id }}">
                                            {{ estudiante.usuario.nombre }} {{ estudiante.usuario.apellido_paterno }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Tabla de historial -->
                            <div class="table-responsive">
                                <table class="table table-striped" id="tabla-historial">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Estudiante</th>
                                            <th>Estado</th>
                                            <th>JustificaciÃ³n</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenarÃ¡ dinÃ¡micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PestaÃ±a ComunicaciÃ³n -->
        <div class="tab-pane fade fade-in" id="comunicacion">
            <div class="row">
                <!-- Formulario para crear comunicaciÃ³n -->
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Nueva ComunicaciÃ³n</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{% url 'asignatura_detalle' asignatura.id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="asunto" class="form-label">Asunto</label>
                                    <input type="text" class="form-control" id="asunto" name="asunto" required>
                                    <small class="text-muted">Se agregarÃ¡ automÃ¡ticamente el cÃ³digo [{{ asignatura.codigo }}]</small>
                                </div>
                                <div class="mb-3">
                                    <label for="contenido" class="form-label">Contenido</label>
                                    <textarea class="form-control" id="contenido" name="contenido" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-paper-plane me-2"></i>Enviar ComunicaciÃ³n
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de comunicaciones -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Comunicaciones</h5>
                            <div>
                                <span class="badge bg-primary">Total: {{ estadisticas_comunicaciones.total_enviadas }}</span>
                                <span class="badge bg-success ms-2">Tasa de lectura: {{ estadisticas_comunicaciones.tasa_lectura }}%</span>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if comunicaciones %}
                                <div class="list-group">
                                    {% for com in comunicaciones %}
                                        <div class="list-group-item" id="comunicacion-{{ com.id }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">{{ com.asunto }}</h6>
                                                <div>
                                                    <small class="text-muted me-3">{{ com.fecha|date:"d/m/Y H:i" }}</small>
                                                    <button class="btn btn-sm btn-danger" onclick="eliminarComunicacion({{ com.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="mb-1">{{ com.descripcion }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    {% for tipo in com.destinatarios %}
                                                        <span class="badge bg-info me-1">{{ tipo }}</span>
                                                    {% endfor %}
                                                </div>
                                                <small class="text-muted">
                                                    <i class="fas fa-eye me-1"></i>{{ com.total_lecturas }} lecturas
                                                </small>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No hay comunicaciones para mostrar</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PestaÃ±a Foro -->
        <div class="tab-pane fade fade-in" id="foro">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Foro de la Asignatura
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <a href="{% url 'foro_asignatura' asignatura.id %}" class="btn btn-primary">
                            <i class="fas fa-comments me-2"></i>Ir al Foro de la Asignatura
                        </a>
                    </div>

                    {% if temas_foro %}
                        <div class="list-group list-group-flush">
                            {% for tema in temas_foro %}
                                <div class="list-group-item {% if tema.es_anuncio %}bg-light{% endif %}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1 {% if tema.es_anuncio %}text-danger{% else %}text-primary{% endif %}">
                                            {% if tema.es_anuncio %}
                                                <i class="fas fa-bullhorn me-2"></i>
                                            {% endif %}
                                            {{ tema.titulo }}
                                        </h6>
                                        <small class="text-muted">{{ tema.fecha|date:"d M, Y" }}</small>
                                    </div>
                                    <p class="mb-1">{{ tema.contenido|truncatewords:30 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            Por: {{ tema.autor.nombre }} {{ tema.autor.apellido_paterno }}
                                        </small>
                                        <div>
                                            <span class="badge bg-info me-2">
                                                <i class="fas fa-reply me-1"></i>{{ tema.mensajes.count }} respuestas
                                            </span>
                                            <a href="{% url 'tema_foro_asignatura' asignatura.id tema.id %}" class="btn btn-sm btn-outline-primary">
                                                Ver tema
                                            </a>
                                        </div>
                                    </div>
                                    {% if tema.mensajes.exists %}
                                        <div class="mt-3 ps-4 border-start">
                                            <p class="text-muted mb-2 small">Ãltima respuesta:</p>
                                            {% with ultimo_mensaje=tema.mensajes.last %}
                                                <div class="bg-light rounded p-3">
                                                    <div class="d-flex justify-content-between">
                                                        <small class="text-primary">{{ ultimo_mensaje.autor.nombre }} {{ ultimo_mensaje.autor.apellido_paterno }}</small>
                                                        <small class="text-muted">{{ ultimo_mensaje.fecha|date:"d M, Y H:i" }}</small>
                                                    </div>
                                                    <p class="mb-0 small">{{ ultimo_mensaje.contenido|truncatewords:20 }}</p>
                                                </div>
                                            {% endwith %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            En el foro de la asignatura podrÃ¡s:
                            <ul class="mb-0 mt-2">
                                <li>Crear temas de discusiÃ³n</li>
                                <li>Participar en discusiones existentes</li>
                                <li>Hacer preguntas sobre la materia</li>
                                {% if es_docente %}
                                <li>Publicar anuncios importantes</li>
                                {% endif %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Generar EvaluaciÃ³n Base -->
<div class="modal fade" id="modalEvaluacionBase" tabindex="-1" aria-labelledby="modalEvaluacionBaseLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEvaluacionBaseLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Generar EvaluaciÃ³n Base
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- InformaciÃ³n de la asignatura -->
                <div class="alert alert-info mb-3">
                    <h6 class="alert-heading">
                        <i class="fas fa-book me-2"></i>{{ asignatura.asignatura.nombre }}
                    </h6>
                    <p class="mb-1">
                        <strong>CÃ³digo:</strong> {{ asignatura.codigo }} | 
                        <strong>Docente:</strong> {{ asignatura.docente.usuario.nombre }} {{ asignatura.docente.usuario.apellido_paterno }}
                    </p>
                </div>

                <!-- Horario de la asignatura -->
                <div class="mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>Horario de Clases
                    </h6>
                    {% if clases %}
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-hover align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th><i class="fas fa-calendar-day me-1"></i>DÃ­a</th>
                                        <th><i class="fas fa-clock me-1"></i>Horario</th>
                                        <th><i class="fas fa-door-open me-1"></i>Sala</th>
                                        <th><i class="fas fa-users me-1"></i>Curso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for clase in clases %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ clase.fecha|date:"l"|title }}</span></td>
                                        <td><i class="fas fa-clock me-1 text-muted"></i>{{ clase.horario }}</td>
                                        <td>{{ clase.sala }}</td>
                                        <td><span class="badge bg-info">{{ clase.curso }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No hay clases registradas para esta asignatura.</p>
                        </div>
                    {% endif %}
                </div>

                <form id="formEvaluacionBase">
                    <div class="mb-3">
                        <label for="nombreEvaluacion" class="form-label">
                            <i class="fas fa-clipboard-list me-2"></i>Nombre de la EvaluaciÃ³n
                        </label>
                        <input type="text" class="form-control" id="nombreEvaluacion" 
                               placeholder="Ej: Control 1, Prueba 2, etc." required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionEvaluacion" class="form-label">
                            <i class="fas fa-align-left me-2"></i>DescripciÃ³n
                        </label>
                        <textarea class="form-control" id="descripcionEvaluacion" rows="3"
                                  placeholder="Describe los objetivos y contenidos de la evaluaciÃ³n..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="ponderacionEvaluacion" class="form-label">
                            <i class="fas fa-percentage me-2"></i>PonderaciÃ³n (%)
                        </label>
                        <input type="number" class="form-control" id="ponderacionEvaluacion" 
                               min="1" max="100" placeholder="Ej: 20" required>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            La ponderaciÃ³n debe estar entre 1% y 100%
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEvaluacionBase">
                    <i class="fas fa-save me-2"></i>Guardar EvaluaciÃ³n Base
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear EvaluaciÃ³n EspecÃ­fica -->
<div class="modal fade" id="modalEvaluacionEspecifica" tabindex="-1" aria-labelledby="modalEvaluacionEspecificaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEvaluacionEspecificaLabel">
                    <i class="fas fa-calendar-plus me-2"></i>Crear EvaluaciÃ³n EspecÃ­fica
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- InformaciÃ³n de la evaluaciÃ³n base seleccionada -->
                <div id="evaluacionBaseInfo" class="mb-3">
                    <!-- Se cargarÃ¡ dinÃ¡micamente -->
                </div>
                
                <!-- InformaciÃ³n de la asignatura -->
                <div id="asignaturaInfo" class="mb-3">
                    <!-- Se cargarÃ¡ dinÃ¡micamente -->
                </div>
                
                <form id="formEvaluacionEspecifica">
                    <div class="mb-3">
                        <label for="claseSelect" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Seleccionar Clase
                        </label>
                        <select class="form-select" id="claseSelect" required>
                            <option value="">Selecciona una clase...</option>
                        </select>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Los bloques estÃ¡n agrupados por pares (2-4, 6-8) e impares (1-2, 3-4)
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="fechaEvaluacion" class="form-label">
                            <i class="fas fa-calendar me-2"></i>Fecha de EvaluaciÃ³n
                        </label>
                        <input type="date" class="form-control" id="fechaEvaluacion" required>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesEvaluacion" class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>Observaciones
                        </label>
                        <textarea class="form-control" id="observacionesEvaluacion" rows="3" 
                                  placeholder="Observaciones adicionales sobre la evaluaciÃ³n..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEvaluacionEspecifica">
                    <i class="fas fa-save me-2"></i>Crear EvaluaciÃ³n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Evaluaciones de Estudiantes -->
<div class="modal fade" id="modalEvaluacionesEstudiantes" tabindex="-1" aria-labelledby="modalEvaluacionesEstudiantesLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEvaluacionesEstudiantesLabel">
                    <i class="fas fa-users me-2"></i>Crear Evaluaciones para Estudiantes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡ seguro de que desea crear evaluaciones para todos los estudiantes de esta evaluaciÃ³n?</p>
                <div id="infoEvaluacionEstudiantes">
                    <!-- InformaciÃ³n de la evaluaciÃ³n se cargarÃ¡ aquÃ­ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnCrearEvaluacionesEstudiantes">
                    <i class="fas fa-user-plus me-2"></i>Crear Evaluaciones
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/system_messages.js' %}"></script>
<script src="{% static 'js/asistencia_actions.js' %}"></script>
<script src="{% static 'js/chat_ia_actions.js' %}"></script>
<script src="{% static 'js/notas_actions.js' %}"></script>
<script src="{% static 'js/evaluaciones_actions.js' %}"></script>
<script>
    $(document).ready(function() {
        // Cargar asistencia cuando se muestra la pestaÃ±a
        $('#asistencia-tab').on('shown.bs.tab', function (e) {
            asistenciaActions.cargarAsistencia({{ asignatura.id }});
        });
    });
</script>

<script>
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            const target = document.querySelector(e.target.getAttribute('data-bs-target'));
            target.classList.add('fade-in');
        });
    });
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.add('loading');
            setTimeout(() => {
                this.classList.remove('loading');
            }, 1000);
        });
    });
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        setTimeout(() => {
            progressBar.style.width = '75%';
        }, 500);
    }
</script>

<script>
function eliminarComunicacion(id) {
    GEMSystemMessage.confirm(
        'Â¿EstÃ¡s seguro de que deseas eliminar esta comunicaciÃ³n?',
        () => {
            // Usuario confirmÃ³, proceder con la eliminaciÃ³n
            fetch(`/comunicacion/${id}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Eliminar el elemento del DOM
                    document.getElementById(`comunicacion-${id}`).remove();
                    // Mostrar mensaje de Ã©xito
                    GEMSystemMessage.success('ComunicaciÃ³n eliminada exitosamente');
                } else {
                    GEMSystemMessage.error(data.message || 'Error al eliminar la comunicaciÃ³n');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                GEMSystemMessage.error('Error al eliminar la comunicaciÃ³n');
            });
        },
        () => {
            // Usuario cancelÃ³, no hacer nada
        }
    );
}
</script>
{% endblock %} 