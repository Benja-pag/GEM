<!-- Pestaña de Reportes -->
<div class="tab-pane fade" id="reportes" role="tabpanel" aria-labelledby="reportes-tab">
    
    <!-- Dashboard de Métricas Principales -->
    <div class="row mb-4" id="dashboard-metricas">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h5 class="card-title">Total Estudiantes</h5>
                    <h2 class="display-6" id="total-estudiantes">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </h2>
                    <small>Registrados</small>
                </div>
            </div>
                    </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                    <h5 class="card-title">Total Docentes</h5>
                    <h2 class="display-6" id="total-docentes">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </h2>
                    <small>Activos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h5 class="card-title">Promedio General</h5>
                    <h2 class="display-6" id="promedio-general">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </h2>
                    <small>Colegio</small>
                </div>
            </div>
                    </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <h5 class="card-title">Asistencia</h5>
                    <h2 class="display-6" id="asistencia-promedio">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </h2>
                    <small>Promedio</small>
                </div>
            </div>
        </div>
                </div>

    <!-- Sistema de Pestañas para Reportes -->
    <div class="container-fluid">
        <ul class="nav nav-tabs mb-4" id="reportesTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="rendimiento-tab" data-bs-toggle="tab" data-bs-target="#rendimiento-academico" type="button" role="tab" aria-controls="rendimiento-academico" aria-selected="true">
                    <i class="fas fa-graduation-cap me-2"></i>Rendimiento Académico
                        </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="asistencia-tab" data-bs-toggle="tab" data-bs-target="#asistencia-reporte" type="button" role="tab" aria-controls="asistencia-reporte" aria-selected="false">
                    <i class="fas fa-calendar-check me-2"></i>Asistencia
                        </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="riesgo-tab" data-bs-toggle="tab" data-bs-target="#estudiantes-riesgo" type="button" role="tab" aria-controls="estudiantes-riesgo" aria-selected="false">
                    <i class="fas fa-exclamation-triangle me-2"></i>Estudiantes en Riesgo
                        </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="evaluaciones-tab" data-bs-toggle="tab" data-bs-target="#evaluaciones-reporte" type="button" role="tab" aria-controls="evaluaciones-reporte" aria-selected="false">
                    <i class="fas fa-clipboard-list me-2"></i>Evaluaciones
                        </button>
            </li>
        </ul>
    </div>

    <!-- Contenido de las Pestañas de Reportes -->
    <div class="tab-content" id="reportesTabContent">
        
        <!-- Pestaña de Rendimiento Académico -->
        <div class="tab-pane fade show active" id="rendimiento-academico" role="tabpanel" aria-labelledby="rendimiento-tab">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0"><i class="fas fa-graduation-cap me-2"></i>Rendimiento Académico por Cursos</h6>
                    <div>
                        <a href="{% url 'descargar_reporte_cursos_pdf' %}" class="btn btn-sm btn-outline-success me-2" title="Descargar reporte en PDF">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </a>
                        <button class="btn btn-sm btn-outline-primary" onclick="generarReporteRendimiento()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="tabla-rendimiento-reportes">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-chalkboard"></i> Curso</th>
                                    <th><i class="fas fa-users"></i> Estudiantes</th>
                                    <th><i class="fas fa-clipboard-list"></i> Evaluaciones</th>
                                    <th><i class="fas fa-chart-line"></i> Promedio</th>
                                    <th><i class="fas fa-percentage"></i> Aprobación</th>
                                    <th><i class="fas fa-calendar-check"></i> Asistencia</th>
                                    <th><i class="fas fa-traffic-light"></i> Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-rendimiento">
                                <!-- Las filas se cargarán dinámicamente -->
                            </tbody>
                        </table>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Pestaña de Asistencia -->
        <div class="tab-pane fade" id="asistencia-reporte" role="tabpanel" aria-labelledby="asistencia-tab">
            
            <!-- Sub-pestañas para Asistencia -->
            <ul class="nav nav-pills mb-3" id="asistencia-sub-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="asistencia-general-tab" data-bs-toggle="pill" data-bs-target="#asistencia-general" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Reporte General
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="asistencia-estudiante-tab" data-bs-toggle="pill" data-bs-target="#asistencia-estudiante" type="button" role="tab">
                        <i class="fas fa-user me-2"></i>Por Estudiante
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="asistencia-curso-tab" data-bs-toggle="pill" data-bs-target="#asistencia-curso" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Por Curso
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="asistencia-sub-content">
                
                <!-- Reporte General de Asistencia -->
                <div class="tab-pane fade show active" id="asistencia-general" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0"><i class="fas fa-calendar-check me-2"></i>Reporte General de Asistencia</h6>
                            <div>
                                <a href="{% url 'descargar_reporte_asistencia_pdf' %}" class="btn btn-sm btn-outline-success me-2" title="Descargar reporte de asistencia en PDF">
                                    <i class="fas fa-file-pdf me-1"></i>PDF
                                </a>
                                <button class="btn btn-sm btn-outline-warning" onclick="generarReporteAsistencia()">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="reporte-asistencia">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reporte de Asistencia por Estudiante -->
                <div class="tab-pane fade" id="asistencia-estudiante" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0"><i class="fas fa-user me-2"></i>Reporte de Asistencia por Estudiante</h6>
                            <div>
                                <label for="periodo-estudiante-tabla" class="form-label me-2">Período:</label>
                                <select class="form-select d-inline-block w-auto" id="periodo-estudiante-tabla">
                                    <option value="ano_actual">Año Actual</option>
                                    <option value="mes_actual">Mes Actual</option>
                                    <option value="semestre_actual">Semestre Actual</option>
                                </select>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="cargarTablaEstudiantes()">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="tabla-estudiantes-container">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando estudiantes...</span>
                                    </div>
                                    <p class="mt-2">Cargando lista de estudiantes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reporte de Asistencia por Curso -->
                <div class="tab-pane fade" id="asistencia-curso" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-users me-2"></i>Reporte de Asistencia por Curso</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="select-curso" class="form-label">Seleccionar Curso:</label>
                                    <select class="form-select" id="select-curso">
                                        <option value="">Cargando cursos...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="periodo-curso" class="form-label">Período:</label>
                                    <select class="form-select" id="periodo-curso">
                                        <option value="ano_actual">Año Actual</option>
                                        <option value="mes_actual">Mes Actual</option>
                                        <option value="semestre_actual">Semestre Actual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="generarReporteAsistenciaCurso()">
                                    <i class="fas fa-chart-bar me-2"></i>Generar Reporte
                                </button>
                                <button class="btn btn-success" onclick="descargarPDFAsistenciaCurso()" disabled id="btn-pdf-curso">
                                    <i class="fas fa-file-pdf me-2"></i>Descargar PDF
                                </button>
                            </div>
                            <div id="reporte-asistencia-curso">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Selecciona un curso y presiona "Generar Reporte" para ver el detalle de asistencia del curso.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Pestaña de Estudiantes en Riesgo -->
        <div class="tab-pane fade" id="estudiantes-riesgo" role="tabpanel" aria-labelledby="riesgo-tab">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Estudiantes en Situación de Riesgo</h6>
                    <div class="btn-group" role="group">
                        <div class="dropdown me-2">
                            <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'descargar_reporte_estudiantes_riesgo_pdf' %}?tipo=completo">
                                    <i class="fas fa-file-pdf text-danger me-2"></i>Reporte Completo
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'descargar_reporte_estudiantes_riesgo_pdf' %}?tipo=academico">
                                    <i class="fas fa-chart-line text-warning me-2"></i>Solo Riesgo Académico
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'descargar_reporte_estudiantes_riesgo_pdf' %}?tipo=asistencia">
                                    <i class="fas fa-calendar-times text-info me-2"></i>Solo Riesgo Asistencia
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="generarReporteEstudiantesRiesgo()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                                </div>
                            </div>
                <div class="card-body" id="reporte-estudiantes-riesgo">
                    <div class="text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Pestaña de Evaluaciones -->
        <div class="tab-pane fade" id="evaluaciones-reporte" role="tabpanel" aria-labelledby="evaluaciones-tab">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0"><i class="fas fa-clipboard-list me-2"></i>Reporte de Evaluaciones por Asignatura</h6>
                    <button class="btn btn-sm btn-outline-info" onclick="generarReporteEvaluaciones()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div class="card-body" id="reporte-evaluaciones">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// Variables globales para reportes
let reportesData = {};
let reportesDataTable = null;

// Función para crear filas vacías sin colspan
function crearFilaVacia(numColumnas, contenido, claseAdicional = '') {
    let fila = '<tr>';
    for (let i = 0; i < numColumnas; i++) {
        if (i === 0) {
            fila += `<td class="text-center ${claseAdicional}">${contenido}</td>`;
        } else {
            fila += '<td></td>';
        }
    }
    fila += '</tr>';
    return fila;
}

// Inicializar reportes al cargar la pestaña
function inicializarReportes() {
    // Mostrar spinner inicial en la tabla
    const tbody = document.getElementById('tbody-rendimiento');
    if (tbody) {
        tbody.innerHTML = crearFilaVacia(7, `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
        `);
    }
    
    cargarDashboardMetricas();
    generarReporteRendimiento();
}

// Cargar métricas del dashboard
function cargarDashboardMetricas() {
    fetch('/api/dashboard-metricas/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarDashboardMetricas(data.data);
            } else {
                console.error('Error al cargar métricas:', data.error);
                mostrarErrorMetricas();
            }
        })
        .catch(error => {
            console.error('Error al cargar métricas del dashboard:', error);
            mostrarErrorMetricas();
        });
}

function mostrarDashboardMetricas(data) {
    document.getElementById('total-estudiantes').innerHTML = data.total_estudiantes || '0';
    document.getElementById('total-docentes').innerHTML = data.total_docentes || '0';
    document.getElementById('promedio-general').innerHTML = (data.promedio_general || 0).toFixed(1);
    document.getElementById('asistencia-promedio').innerHTML = (data.asistencia_promedio || 0).toFixed(1) + '%';
}

function mostrarErrorMetricas() {
    document.getElementById('total-estudiantes').innerHTML = '<small class="text-danger">Error</small>';
    document.getElementById('total-docentes').innerHTML = '<small class="text-danger">Error</small>';
    document.getElementById('promedio-general').innerHTML = '<small class="text-danger">Error</small>';
    document.getElementById('asistencia-promedio').innerHTML = '<small class="text-danger">Error</small>';
}

// Generar reporte de rendimiento por cursos
function generarReporteRendimiento() {
    const tbody = document.getElementById('tbody-rendimiento');
    tbody.innerHTML = crearFilaVacia(7, `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando datos...</span>
        </div>
    `);

    // Destruir DataTable existente si existe
    if (reportesDataTable) {
        reportesDataTable.destroy();
        reportesDataTable = null;
    }

    fetch('/api/reporte-rendimiento-cursos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarTablaRendimiento(data.data);
                reportesData.rendimiento = data.data;
            } else {
                console.error('Error al cargar reporte de rendimiento:', data.error);
                mostrarErrorTabla('tbody-rendimiento', 7);
            }
        })
        .catch(error => {
            console.error('Error al cargar reporte de rendimiento:', error);
            mostrarErrorTabla('tbody-rendimiento', 7);
        });
}

function mostrarTablaRendimiento(cursos) {
    const tbody = document.getElementById('tbody-rendimiento');
    
    if (!cursos || cursos.length === 0) {
        tbody.innerHTML = crearFilaVacia(7, 'No hay datos disponibles para el período seleccionado', 'text-muted');
        return;
    }

    tbody.innerHTML = cursos.map(curso => {
        const promedio = curso.promedio_curso || curso.promedio || 0;
        const aprobacion = curso.porcentaje_aprobacion || 0;
        const asistencia = curso.porcentaje_asistencia || 0;
        const estado = curso.estado || 'N/A';
        const estadoClase = curso.estado_clase || 'secondary';
        
        // Determinar color de la barra de asistencia basado en el estado
        let asistenciaBarClass = 'success';
        if (asistencia < 83) {
            asistenciaBarClass = 'danger';
        } else if (asistencia < 85) {
            asistenciaBarClass = 'warning';
        }
        
        return `
            <tr>
                <td><span class="badge bg-primary">${curso.curso}</span></td>
                <td><span class="badge bg-info">${curso.total_estudiantes}</span></td>
                <td><span class="badge bg-secondary">${curso.total_evaluaciones}</span></td>
                <td><strong>${promedio.toFixed(2)}</strong></td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${aprobacion}%">
                            ${aprobacion.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-${asistenciaBarClass}" role="progressbar" 
                             style="width: ${asistencia}%">
                            ${asistencia.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td><span class="badge bg-${estadoClase}">${estado}</span></td>
            </tr>
        `;
    }).join('');
}

// Generar reporte de asistencia
function generarReporteAsistencia() {
    const container = document.getElementById('reporte-asistencia');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;

    fetch('/api/reporte-asistencia-cursos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarReporteAsistencia(data.data);
            } else {
                console.error('Error al cargar reporte de asistencia:', data.error);
                mostrarErrorReporte('reporte-asistencia');
            }
        })
        .catch(error => {
            console.error('Error al cargar reporte de asistencia:', error);
            mostrarErrorReporte('reporte-asistencia');
        });
}

function mostrarReporteAsistencia(data) {
    const container = document.getElementById('reporte-asistencia');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay datos de asistencia disponibles</p>';
        return;
    }

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th><i class="fas fa-chalkboard"></i> Curso</th>
                        <th><i class="fas fa-users"></i> Estudiantes</th>
                        <th><i class="fas fa-clipboard-list"></i> Registros</th>
                        <th><i class="fas fa-check-circle"></i> Presentes</th>
                        <th><i class="fas fa-times-circle"></i> Ausentes</th>
                        <th><i class="fas fa-calendar-check"></i> % Asistencia</th>
                        <th><i class="fas fa-exclamation-triangle"></i> En Riesgo</th>
                        <th><i class="fas fa-traffic-light"></i> Estado</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(curso => {
                        const asistencia = curso.porcentaje_asistencia || 0;
                        const estadoClass = curso.estado_clase || 'secondary';
                        const estado = curso.estado || 'N/A';
                        
                        // Determinar clase de color para la barra de progreso
                        let progressClass = 'secondary';
                        if (asistencia >= 85) {
                            progressClass = 'success';
                        } else if (asistencia >= 83) {
                            progressClass = 'warning';
                        } else if (asistencia > 0) {
                            progressClass = 'danger';
                        }
                        
                        return `
                            <tr>
                                <td><span class="badge bg-primary">${curso.curso}</span></td>
                                <td><span class="badge bg-info">${curso.total_estudiantes}</span></td>
                                <td><span class="badge bg-secondary">${curso.total_registros.toLocaleString()}</span></td>
                                <td><span class="badge bg-success">${curso.presentes.toLocaleString()}</span></td>
                                <td><span class="badge bg-danger">${curso.ausentes.toLocaleString()}</span></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${progressClass}" role="progressbar" 
                                             style="width: ${Math.max(asistencia, 5)}%">
                                            ${asistencia.toFixed(1)}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    ${curso.estudiantes_riesgo > 0 ? 
                                        `<span class="badge bg-warning">${curso.estudiantes_riesgo}</span>` : 
                                        `<span class="badge bg-success">0</span>`
                                    }
                                </td>
                                <td><span class="badge bg-${estadoClass}">${estado}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Generar reporte de estudiantes en riesgo
function generarReporteEstudiantesRiesgo() {
    const container = document.getElementById('reporte-estudiantes-riesgo');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;

    fetch('/api/reporte-estudiantes-riesgo/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarReporteEstudiantesRiesgo(data.data);
            } else {
                console.error('Error al cargar reporte de estudiantes en riesgo:', data.error);
                mostrarErrorReporte('reporte-estudiantes-riesgo');
            }
        })
        .catch(error => {
            console.error('Error al cargar reporte de estudiantes en riesgo:', error);
            mostrarErrorReporte('reporte-estudiantes-riesgo');
        });
}

function mostrarReporteEstudiantesRiesgo(data) {
    const container = document.getElementById('reporte-estudiantes-riesgo');
    
    if (!data || (!data.riesgo_notas && !data.riesgo_asistencia) || 
        (data.riesgo_notas && data.riesgo_notas.length === 0 && data.riesgo_asistencia && data.riesgo_asistencia.length === 0)) {
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="alert alert-success border-0 shadow-sm">
                    <div class="mb-3">
                        <i class="fas fa-shield-check fa-4x text-success mb-3"></i>
                    </div>
                    <h4 class="text-success mb-3">¡Situación Óptima!</h4>
                    <p class="mb-2 fs-5">No hay estudiantes en situación de riesgo</p>
                    <small class="text-muted">Todos los estudiantes cumplen con los estándares académicos y de asistencia</small>
                    <div class="mt-3">
                        <span class="badge bg-success fs-6 me-2">
                            <i class="fas fa-graduation-cap me-1"></i>Rendimiento: Excelente
                        </span>
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-calendar-check me-1"></i>Asistencia: Óptima
                        </span>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    // Estadísticas generales
    const totalRiesgoNotas = data.riesgo_notas ? data.riesgo_notas.length : 0;
    const totalRiesgoAsistencia = data.riesgo_asistencia ? data.riesgo_asistencia.length : 0;
    const totalEstudiantesRiesgo = new Set([
        ...(data.riesgo_notas || []).map(e => e.rut),
        ...(data.riesgo_asistencia || []).map(e => e.rut)
    ]).size;

    // Calcular estadísticas adicionales
    const promedioMasBajo = data.riesgo_notas && data.riesgo_notas.length > 0 ? 
        Math.min(...data.riesgo_notas.map(e => e.promedio)) : null;
    const asistenciaMasBaja = data.riesgo_asistencia && data.riesgo_asistencia.length > 0 ? 
        Math.min(...data.riesgo_asistencia.map(e => e.asistencia)) : null;

    // Agrupar por curso para análisis
    const cursosAfectados = new Set([
        ...(data.riesgo_notas || []).map(e => e.curso),
        ...(data.riesgo_asistencia || []).map(e => e.curso)
    ]);

    let html = `
        <!-- Alerta de situación -->
        <div class="alert alert-warning border-0 shadow-sm mb-4">
            <div class="row align-items-center">
                <div class="col-auto">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                </div>
                <div class="col">
                    <h6 class="alert-heading mb-1">Atención Requerida</h6>
                    <p class="mb-0">Se han identificado <strong>${totalEstudiantesRiesgo} estudiantes únicos</strong> en situación de riesgo en <strong>${cursosAfectados.size} cursos</strong></p>
                </div>
            </div>
        </div>

        <!-- Resumen estadístico mejorado -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-danger shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <i class="fas fa-chart-line fa-2x text-danger"></i>
                            <span class="badge bg-danger">${totalRiesgoNotas > 0 ? 'CRÍTICO' : 'OK'}</span>
                        </div>
                        <h3 class="text-danger mb-1">${totalRiesgoNotas}</h3>
                        <p class="text-muted mb-1">Riesgo Académico</p>
                        ${promedioMasBajo !== null ? 
                            `<small class="text-danger"><i class="fas fa-arrow-down me-1"></i>Mín: ${promedioMasBajo.toFixed(2)}</small>` : 
                            '<small class="text-success"><i class="fas fa-check me-1"></i>Sin riesgo</small>'
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-warning shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <i class="fas fa-calendar-times fa-2x text-warning"></i>
                            <span class="badge bg-warning text-dark">${totalRiesgoAsistencia > 0 ? 'ALERTA' : 'OK'}</span>
                        </div>
                        <h3 class="text-warning mb-1">${totalRiesgoAsistencia}</h3>
                        <p class="text-muted mb-1">Riesgo Asistencia</p>
                        ${asistenciaMasBaja !== null ? 
                            `<small class="text-warning"><i class="fas fa-arrow-down me-1"></i>Mín: ${asistenciaMasBaja.toFixed(1)}%</small>` : 
                            '<small class="text-success"><i class="fas fa-check me-1"></i>Sin riesgo</small>'
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-info shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <i class="fas fa-users fa-2x text-info"></i>
                            <span class="badge bg-info">TOTAL</span>
                        </div>
                        <h3 class="text-info mb-1">${totalEstudiantesRiesgo}</h3>
                        <p class="text-muted mb-1">Estudiantes Únicos</p>
                        <small class="text-info"><i class="fas fa-users me-1"></i>Requieren seguimiento</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <i class="fas fa-school fa-2x text-secondary"></i>
                            <span class="badge bg-secondary">CURSOS</span>
                        </div>
                        <h3 class="text-secondary mb-1">${cursosAfectados.size}</h3>
                        <p class="text-muted mb-1">Cursos Afectados</p>
                        <small class="text-secondary"><i class="fas fa-exclamation-circle me-1"></i>Con estudiantes en riesgo</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
    `;
    
    // Estudiantes en riesgo por notas - Diseño mejorado
    if (data.riesgo_notas && data.riesgo_notas.length > 0) {
        // Agrupar por nivel de riesgo
        const riesgoCritico = data.riesgo_notas.filter(e => e.promedio < 3.0);
        const riesgoModerado = data.riesgo_notas.filter(e => e.promedio >= 3.0);
        
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-danger shadow">
                    <div class="card-header bg-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Riesgo Académico
                                </h6>
                                <small>Promedio < 4.0 (Nota mínima de aprobación)</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark fs-6">${data.riesgo_notas.length}</span>
                                <br><small>estudiantes</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        ${riesgoCritico.length > 0 ? `
                            <div class="bg-danger bg-opacity-10 p-3 border-bottom">
                                <h6 class="text-danger mb-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Riesgo Crítico (< 3.0) - ${riesgoCritico.length} estudiantes
                                </h6>
                                <div class="row">
                                    ${riesgoCritico.map(est => `
                                        <div class="col-md-6 mb-2">
                                            <div class="card border-danger">
                                                <div class="card-body p-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong class="text-danger">${est.nombre}</strong>
                                                            <br><small class="text-muted">${est.rut} - ${est.curso}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <span class="badge bg-danger fs-6">${est.promedio.toFixed(2)}</span>
                                                            <br><small class="text-muted">${est.total_evaluaciones} eval.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${riesgoModerado.length > 0 ? `
                            <div class="p-3">
                                <h6 class="text-warning mb-2">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    Riesgo Moderado (3.0 - 3.9) - ${riesgoModerado.length} estudiantes
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Estudiante</th>
                                                <th>Curso</th>
                                                <th>Promedio</th>
                                                <th>Evaluaciones</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${riesgoModerado.map(est => `
                                                <tr>
                                                    <td>
                                                        <div>
                                                            <strong>${est.nombre}</strong>
                                                            <br><small class="text-muted">${est.rut}</small>
                                                        </div>
                                                    </td>
                                                    <td><span class="badge bg-primary">${est.curso}</span></td>
                                                    <td>
                                                        <span class="badge bg-warning fs-6">
                                                            ${est.promedio.toFixed(2)}
                                                        </span>
                                                    </td>
                                                    <td><span class="text-muted">${est.total_evaluaciones}</span></td>
                                                    <td>
                                                        <small class="text-warning">
                                                            <i class="fas fa-clock me-1"></i>Requiere apoyo
                                                        </small>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    } else {
        // Mostrar mensaje positivo si no hay riesgo académico
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-success shadow">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Rendimiento Académico
                        </h6>
                    </div>
                    <div class="card-body text-center py-5">
                        <i class="fas fa-trophy fa-3x text-success mb-3"></i>
                        <h5 class="text-success">¡Excelente Rendimiento!</h5>
                        <p class="text-muted mb-0">Todos los estudiantes mantienen promedios superiores a 4.0</p>
                        <div class="mt-3">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check me-1"></i>Sin estudiantes en riesgo académico
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Estudiantes en riesgo por asistencia - Diseño mejorado
    if (data.riesgo_asistencia && data.riesgo_asistencia.length > 0) {
        // Agrupar por nivel de riesgo de asistencia
        const asistenciaCritica = data.riesgo_asistencia.filter(e => e.asistencia < 70);
        const asistenciaModerada = data.riesgo_asistencia.filter(e => e.asistencia >= 70);
        
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-warning shadow">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-times me-2"></i>
                                    Riesgo de Asistencia
                                </h6>
                                <small>Asistencia < 85% (Mínimo requerido)</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-dark fs-6">${data.riesgo_asistencia.length}</span>
                                <br><small>estudiantes</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                        ${asistenciaCritica.length > 0 ? `
                            <div class="bg-danger bg-opacity-10 p-3 border-bottom">
                                <h6 class="text-danger mb-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Asistencia Crítica (< 70%) - ${asistenciaCritica.length} estudiantes
                                </h6>
                                <div class="row">
                                    ${asistenciaCritica.slice(0, 6).map(est => `
                                        <div class="col-md-6 mb-2">
                                            <div class="card border-danger">
                                                <div class="card-body p-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong class="text-danger">${est.nombre}</strong>
                                                            <br><small class="text-muted">${est.rut} - ${est.curso}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <span class="badge bg-danger fs-6">${est.asistencia.toFixed(1)}%</span>
                                                            <br><small class="text-muted">${est.total_asistencias} reg.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${asistenciaCritica.length > 6 ? `
                                    <small class="text-muted">Y ${asistenciaCritica.length - 6} estudiantes más con asistencia crítica...</small>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="p-3">
                            <h6 class="text-warning mb-2">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                Asistencia en Riesgo (70% - 84%) - ${asistenciaModerada.length} estudiantes
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Estudiante</th>
                                            <th>Curso</th>
                                            <th>Asistencia</th>
                                            <th>Registros</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${asistenciaModerada.slice(0, 20).map(est => `
                                            <tr>
                                                <td>
                                                    <div>
                                                        <strong>${est.nombre}</strong>
                                                        <br><small class="text-muted">${est.rut}</small>
                                                    </div>
                                                </td>
                                                <td><span class="badge bg-primary">${est.curso}</span></td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-warning fs-6 me-2">
                                                            ${est.asistencia.toFixed(1)}%
                                                        </span>
                                                        <div class="progress" style="width: 50px; height: 6px;">
                                                            <div class="progress-bar bg-warning" style="width: ${est.asistencia}%"></div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span class="text-muted">${est.total_asistencias}</span></td>
                                                <td>
                                                    <small class="text-warning">
                                                        <i class="fas fa-eye me-1"></i>Monitorear
                                                    </small>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${asistenciaModerada.length > 20 ? `
                                <div class="text-center mt-2">
                                    <small class="text-muted">Mostrando 20 de ${asistenciaModerada.length} estudiantes. Ver PDF completo para todos los datos.</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Mostrar mensaje positivo si no hay riesgo de asistencia
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-success shadow">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-check me-2"></i>
                            Asistencia Escolar
                        </h6>
                    </div>
                    <div class="card-body text-center py-5">
                        <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                        <h5 class="text-success">¡Asistencia Óptima!</h5>
                        <p class="text-muted mb-0">Todos los estudiantes mantienen asistencia superior al 85%</p>
                        <div class="mt-3">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check me-1"></i>Sin estudiantes en riesgo de asistencia
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    html += '</div>';
    

    
    container.innerHTML = html;
}

// Generar reporte de evaluaciones
function generarReporteEvaluaciones() {
    const container = document.getElementById('reporte-evaluaciones');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;

    fetch('/api/reporte-evaluaciones/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarReporteEvaluaciones(data.data);
            } else {
                console.error('Error al cargar reporte de evaluaciones:', data.error);
                mostrarErrorReporte('reporte-evaluaciones');
            }
        })
        .catch(error => {
            console.error('Error al cargar reporte de evaluaciones:', error);
            mostrarErrorReporte('reporte-evaluaciones');
        });
}

function mostrarReporteEvaluaciones(data) {
    const container = document.getElementById('reporte-evaluaciones');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay datos de evaluaciones disponibles</p>';
        return;
    }

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th><i class="fas fa-book"></i> Asignatura</th>
                        <th><i class="fas fa-clipboard-list"></i> Evaluaciones</th>
                        <th><i class="fas fa-users"></i> Estudiantes Evaluados</th>
                        <th><i class="fas fa-chart-line"></i> Promedio</th>
                        <th><i class="fas fa-percentage"></i> Aprobación</th>
                        <th><i class="fas fa-traffic-light"></i> Estado</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(asignatura => {
                        const promedio = asignatura.promedio || 0;
                        const aprobacion = asignatura.porcentaje_aprobacion || 0;
                        const estadoClass = promedio >= 6.0 ? 'success' : 
                                          promedio >= 5.0 ? 'warning' : 'danger';
                        const estadoTexto = promedio >= 6.0 ? 'Excelente' : 
                                          promedio >= 5.0 ? 'Regular' : 'Crítico';
                        return `
                            <tr>
                                <td><strong>${asignatura.asignatura}</strong></td>
                                <td><span class="badge bg-secondary">${asignatura.total_evaluaciones}</span></td>
                                <td><span class="badge bg-info">${asignatura.total_estudiantes || 'N/A'}</span></td>
                                <td><strong>${promedio.toFixed(1)}</strong></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${estadoClass}" role="progressbar" 
                                             style="width: ${aprobacion}%">
                                            ${aprobacion.toFixed(1)}%
    </div>
</div> 
                                </td>
                                <td><span class="badge bg-${estadoClass}">${estadoTexto}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Funciones de utilidad
function mostrarErrorTabla(tbodyId, numColumnas) {
    document.getElementById(tbodyId).innerHTML = crearFilaVacia(numColumnas, 
        '<i class="fas fa-exclamation-triangle me-2"></i>Error al cargar los datos', 
        'text-danger'
    );
}

function mostrarErrorReporte(containerId) {
    document.getElementById(containerId).innerHTML = `
        <div class="text-center text-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <p class="mb-0">Error al cargar el reporte</p>
        </div>
    `;
}

// Actualizar reportes
function actualizarReportes() {
    // Mostrar indicador de carga
    document.querySelectorAll('.spinner-border').forEach(spinner => {
        spinner.style.display = 'inline-block';
    });
    
    // Recargar todos los reportes
    cargarDashboardMetricas();
    
    // Determinar qué pestaña está activa y cargar solo ese reporte
    const activeTab = document.querySelector('#reportesTabs .nav-link.active');
    if (activeTab) {
        const tabId = activeTab.id;
        switch(tabId) {
            case 'rendimiento-tab':
                generarReporteRendimiento();
                break;
            case 'asistencia-tab':
                generarReporteAsistencia();
                break;
            case 'riesgo-tab':
                generarReporteEstudiantesRiesgo();
                break;
            case 'evaluaciones-tab':
                generarReporteEvaluaciones();
                break;
        }
    }
}

// Inicializar reportes cuando se carga la pestaña
document.addEventListener('DOMContentLoaded', function() {
    // Detectar cuando se activa la pestaña de reportes principal
    const reportesTab = document.getElementById('reportes-tab');
    if (reportesTab) {
        reportesTab.addEventListener('shown.bs.tab', function() {
            inicializarReportes();
        });
        
        // Si la pestaña de reportes está activa al cargar la página
        if (reportesTab.classList.contains('active')) {
            inicializarReportes();
        }
    }

    // Detectar cambios en las pestañas internas de reportes
    const reportesInternos = document.querySelectorAll('#reportesTabs .nav-link');
    reportesInternos.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
            const tabId = this.id;
            switch(tabId) {
                case 'rendimiento-tab':
                    generarReporteRendimiento();
                    break;
                case 'asistencia-tab':
                    generarReporteAsistencia();
                    break;
                case 'riesgo-tab':
                    generarReporteEstudiantesRiesgo();
                    break;
                case 'evaluaciones-tab':
                    generarReporteEvaluaciones();
                    break;
            }
        });
    });
});
</script> 