<!-- Pesta√±a de Calendario General para Docentes -->
<div class="tab-pane fade" id="calendario-general">
    <div class="row g-4">
        <!-- Panel Principal del Calendario -->
        <div class="col-lg-8">
            <!-- Calendario Principal Din√°mico -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Calendario General de Actividades
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalCrearEvento">
                            <i class="fas fa-plus me-2"></i>Crear Evento
                        </button>
                    </div>
                                        </div>
                <div class="card-body">
                    <div id='calendario-general-docente'></div>
                    </div>
                </div>
            </div>

        <!-- Panel Lateral - Pr√≥ximos Eventos -->
        <div class="col-lg-4">
            <!-- Pr√≥ximos Eventos -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Pr√≥ximos Eventos
                    </h5>
                    <button class="btn btn-sm btn-light" onclick="refreshEventList()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0" id="proximos-eventos-container" style="max-height: 600px; overflow-y: auto;">
                    <div class="p-4 text-center text-muted">Cargando eventos...</div>
                                </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
<!-- Modal para Crear Evento -->
<div class="modal fade" id="modalCrearEvento" tabindex="-1" aria-labelledby="modalCrearEventoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalCrearEventoLabel">
                    <i class="fas fa-plus me-2"></i>Crear Nuevo Evento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
            <div class="modal-body">
                <form id="form-crear-evento">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipo-evento" class="form-label">Tipo de Evento</label>
                            <select class="form-select" id="tipo-evento" required onchange="updateEventTypeFields()">
                                <option value="">Selecciona el tipo</option>
                                <option value="REUNION">üìÖ Reuni√≥n</option>
                                <option value="EVALUACION">üìù Evaluaci√≥n</option>
                                <option value="TAREA">üìö Tarea/Actividad</option>
                                <option value="MATERIAL">üìã Material de Clase</option>
                                <option value="ENTREGA">üì§ Entrega/Proyecto</option>
                                <option value="EVENTO_COLEGIO">üè´ Evento del Colegio</option>
                                <option value="CAPACITACION">üéì Capacitaci√≥n</option>
                                <option value="CANCELAR_CLASE">‚ùå Cancelar Clase</option>
                                <option value="OTRO">üìå Otro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="asignatura-evento" class="form-label">Asignatura <span class="text-danger" id="asignatura-required" style="display: none;">*</span></label>
                            <select class="form-select" id="asignatura-evento">
                                <option value="">Sin asignatura espec√≠fica</option>
                                {% for asignatura in asignaturas %}
                                <option value="{{ asignatura.id }}" data-asignatura-info='{{ asignatura|safe }}'>{{ asignatura.asignatura.nombre }} ({{ asignatura.codigo }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="titulo-evento" class="form-label">T√≠tulo del Evento</label>
                            <input type="text" class="form-control" id="titulo-evento" required placeholder="Ej: Reuni√≥n de Departamento, Prueba de Matem√°ticas...">
                        </div>
                        <div class="col-md-4 mb-3" id="campo-curso-info">
                            <label for="curso-info-evento" class="form-label">Curso</label>
                            <input type="text" class="form-control" id="curso-info-evento" readonly placeholder="Selecciona una asignatura">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha-evento" class="form-label">Fecha</label>
                            <select class="form-select" id="fecha-evento" required disabled>
                                <option value="">Selecciona una asignatura primero</option>
                            </select>
                            <small class="form-text text-muted">Solo se muestran d√≠as donde se imparte la asignatura</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bloque-evento" class="form-label">Bloque/Horario</label>
                            <select class="form-select" id="bloque-evento" required disabled>
                                <option value="">Selecciona una fecha primero</option>
                            </select>
                            <small class="form-text text-muted">Se muestran los bloques de la asignatura en esa fecha</small>
                        </div>
                    </div>
                    <div class="mb-3" id="campo-ubicacion">
                        <label for="ubicacion-evento" class="form-label">Ubicaci√≥n</label>
                        <input type="text" class="form-control" id="ubicacion-evento" placeholder="Ej: Sala de Profesores, Aula 2-A, Biblioteca...">
                        <small class="form-text text-muted">Para asignaturas, se usa autom√°ticamente la sala correspondiente</small>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion-evento" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="descripcion-evento" rows="3" placeholder="Descripci√≥n detallada del evento..."></textarea>
                        </div>
                    <div class="mb-3" id="campo-materiales" style="display: none;">
                        <label for="materiales-evento" class="form-label">Materiales Necesarios</label>
                        <textarea class="form-control" id="materiales-evento" rows="2" placeholder="Lista de materiales que los estudiantes deben traer..."></textarea>
                    </div>
                    
                    <div class="row" id="campos-evaluacion" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label for="ponderacion-evento" class="form-label">Ponderaci√≥n (%)</label>
                            <input type="number" class="form-control" id="ponderacion-evento" min="1" max="100" placeholder="Ej: 20">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipo-evaluacion" class="form-label">Tipo de Evaluaci√≥n</label>
                            <select class="form-select" id="tipo-evaluacion">
                                <option value="">Seleccionar...</option>
                                <option value="PRUEBA">Prueba Escrita</option>
                                <option value="ORAL">Evaluaci√≥n Oral</option>
                                <option value="PRACTICA">Evaluaci√≥n Pr√°ctica</option>
                                <option value="PROYECTO">Proyecto</option>
                                <option value="TALLER">Taller</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearEventForm()">
                    <i class="fas fa-broom me-2"></i>Limpiar
                </button>
                <button type="submit" form="form-crear-evento" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Crear Evento
                </button>
                        </div>
                        </div>
                    </div>
                </div>

<!-- Modal para Editar Evento -->
<div class="modal fade" id="modalEditarEvento" tabindex="-1" aria-labelledby="modalEditarEventoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalEditarEventoLabel">
                    <i class="fas fa-edit me-2"></i>Editar Evento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-evento">
                    <input type="hidden" id="evento-id-edit" value="">
                    <input type="hidden" id="evento-type-edit" value="">
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="titulo-evento-edit" class="form-label">T√≠tulo del Evento</label>
                            <input type="text" class="form-control" id="titulo-evento-edit" required>
                </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha-evento-edit" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha-evento-edit" required>
                        </div>
                        <div class="col-md-6 mb-3" id="campo-ubicacion-edit">
                            <label for="ubicacion-evento-edit" class="form-label">Ubicaci√≥n</label>
                            <input type="text" class="form-control" id="ubicacion-evento-edit">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion-evento-edit" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="descripcion-evento-edit" rows="3"></textarea>
                    </div>
                    <div class="mb-3" id="campo-materiales-edit" style="display: none;">
                        <label for="materiales-evento-edit" class="form-label">Materiales</label>
                        <textarea class="form-control" id="materiales-evento-edit" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="submit" form="form-editar-evento" class="btn btn-info">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
                    </div>
                </div>
            </div>

<style>
/* Estilos para el calendario general de docentes */
.event-list-item-general {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.2s ease;
}

.event-list-item-general:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.event-list-item-general:last-child {
    border-bottom: none;
}

.event-list-item-general .event-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
}

.event-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.event-time {
    font-size: 0.9rem;
    color: #6c757d;
}

.modal-header.bg-warning {
    border-bottom: 1px solid #ffc107;
}

.modal-header.bg-success {
    border-bottom: 1px solid #198754;
}

.priority-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

/* Colores para diferentes tipos de eventos */
.bg-reunion { background-color: #6f42c1; }
.bg-evaluacion { background-color: #dc3545; }
.bg-tarea { background-color: #fd7e14; }
.bg-material { background-color: #20c997; }
.bg-entrega { background-color: #0d6efd; }
.bg-evento-colegio { background-color: #6610f2; }
.bg-capacitacion { background-color: #d63384; }
.bg-otro { background-color: #6c757d; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendario-general-docente');
    var calendarTab = document.getElementById('calendario-general-tab');
    var calendarInstance = null;
    var allEvents = [];

    function initializeCalendarGeneral() {
        if (calendarInstance) return;

        // Obtener eventos del backend
        try {
            allEvents = JSON.parse('{{ eventos_calendario|safe }}');
            console.log('Eventos cargados:', allEvents);
        } catch (e) {
            console.error('Error parseando eventos:', e);
            allEvents = [];
        }

        calendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            events: allEvents,
            eventDisplay: 'block',
            eventClick: function(info) {
                showEventDetails(info.event);
            },
            dateClick: function(info) {
                // Autocompletar fecha en el formulario y abrir modal de crear evento
                document.getElementById('fecha-evento').value = info.dateStr;
                var modal = new bootstrap.Modal(document.getElementById('modalCrearEvento'));
                modal.show();
            }
        });

        calendarInstance.render();
        updateProximosEventos();
    }

    function updateProximosEventos() {
        var container = document.getElementById('proximos-eventos-container');
        var hoy = new Date();
        var proximosEventos = allEvents.filter(event => {
            var eventDate = new Date(event.start);
            return eventDate >= hoy;
        }).sort((a, b) => new Date(a.start) - new Date(b.start)).slice(0, 12);

        if (proximosEventos.length === 0) {
            container.innerHTML = '<div class="p-4 text-center text-muted"><i class="fas fa-calendar-times fa-2x mb-3 text-muted"></i><br>No hay eventos pr√≥ximos.</div>';
            return;
        }

        container.innerHTML = '';
        proximosEventos.forEach(event => {
            var eventDate = new Date(event.start);
            var eventEl = document.createElement('div');
            eventEl.className = 'event-list-item-general';
            
            var icon = getEventIcon(event.extendedProps.type);
            var timeText = eventDate.toLocaleDateString('es-ES', { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short'
            });
            var hourText = eventDate.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Calcular d√≠as restantes
            var diasRestantes = Math.ceil((eventDate - hoy) / (1000 * 60 * 60 * 24));
            var tiempoTexto = diasRestantes === 0 ? 'Hoy' : 
                            diasRestantes === 1 ? 'Ma√±ana' :
                            `En ${diasRestantes} d√≠as`;

            // Prioridad si existe
            var prioridadBadge = '';
            if (event.extendedProps.prioridad) {
                var prioridadColor = event.extendedProps.prioridad === 'URGENTE' ? 'bg-danger' :
                                   event.extendedProps.prioridad === 'ALTA' ? 'bg-warning' : 'bg-info';
                prioridadBadge = `<span class="badge priority-badge ${prioridadColor}">${event.extendedProps.prioridad}</span>`;
            }

            eventEl.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="event-icon ${getEventBg(event.extendedProps.type)}">
                        <i class="${icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${event.title}</h6>
                        <div class="event-time mb-1">
                            <i class="fas fa-clock me-1"></i>${timeText} - ${hourText}
                    </div>
                        <div class="mb-2">
                            <span class="badge event-badge ${getEventBadge(event.extendedProps.type)}">${getEventTypeLabel(event.extendedProps.type)}</span>
                            <span class="badge bg-secondary event-badge">${tiempoTexto}</span>
                            ${prioridadBadge}
                    </div>
                        ${event.description ? `<small class="text-muted">${event.description}</small>` : ''}
                        <div class="mt-2">
                            ${event.extendedProps.puede_editar ? `
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editarEvento('${event.id}', event)" title="Editar evento">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            ${event.extendedProps.puede_eliminar ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarEvento('${event.id}', '${event.title}', event)" title="Eliminar evento">
                                    <i class="fas fa-trash"></i>
                        </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            eventEl.addEventListener('click', function() {
                showEventDetails(event);
            });
            
            container.appendChild(eventEl);
        });
    }

    function getEventIcon(type) {
        switch(type) {
            case 'REUNION': return 'fas fa-users text-white';
            case 'EVALUACION': return 'fas fa-clipboard-check text-white';
            case 'TAREA': return 'fas fa-tasks text-white';
            case 'MATERIAL': return 'fas fa-book-open text-white';
            case 'ENTREGA': return 'fas fa-upload text-white';
            case 'EVENTO_COLEGIO': return 'fas fa-school text-white';
            case 'CAPACITACION': return 'fas fa-graduation-cap text-white';
            case 'Colegio': return 'fas fa-school text-white';
            case 'Asignatura': return 'fas fa-book text-white';
            case 'Cancelacion': return 'fas fa-times-circle text-white';
            default: return 'fas fa-calendar text-white';
        }
    }

    function getEventBg(type) {
        switch(type) {
            case 'REUNION': return 'bg-reunion';
            case 'EVALUACION': return 'bg-evaluacion';
            case 'TAREA': return 'bg-tarea';
            case 'MATERIAL': return 'bg-material';
            case 'ENTREGA': return 'bg-entrega';
            case 'EVENTO_COLEGIO': return 'bg-evento-colegio';
            case 'CAPACITACION': return 'bg-capacitacion';
            case 'Colegio': return 'bg-primary';
            case 'Asignatura': return 'bg-success';
            case 'Cancelacion': return 'bg-danger';
            default: return 'bg-otro';
        }
    }

    function getEventBadge(type) {
        return getEventBg(type);
    }

    function getEventTypeLabel(type) {
        switch(type) {
            case 'REUNION': return 'Reuni√≥n';
            case 'EVALUACION': return 'Evaluaci√≥n';
            case 'TAREA': return 'Tarea';
            case 'MATERIAL': return 'Material';
            case 'ENTREGA': return 'Entrega';
            case 'EVENTO_COLEGIO': return 'Evento Colegio';
            case 'CAPACITACION': return 'Capacitaci√≥n';
            case 'Colegio': return 'Colegio';
            case 'Asignatura': return 'Asignatura';
            case 'Cancelacion': return 'Cancelaci√≥n';
            default: return type;
        }
    }

    function showEventDetails(event) {
        var eventDate = new Date(event.start);
        var formattedDate = eventDate.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        var details = `
            <div class="alert alert-info">
                <h5><i class="${getEventIcon(event.extendedProps.type).replace('text-white', 'text-info')} me-2"></i>${event.title}</h5>
                <hr>
                <p><strong>Fecha y Hora:</strong> ${formattedDate}</p>
                <p><strong>Tipo:</strong> <span class="badge ${getEventBadge(event.extendedProps.type)}">${getEventTypeLabel(event.extendedProps.type)}</span></p>
                ${event.extendedProps.description ? `<p><strong>Descripci√≥n:</strong> ${event.extendedProps.description}</p>` : ''}
                ${event.extendedProps.ubicacion ? `<p><strong>Ubicaci√≥n:</strong> ${event.extendedProps.ubicacion}</p>` : ''}
                ${event.extendedProps.materiales ? `<p><strong>Materiales:</strong> ${event.extendedProps.materiales}</p>` : ''}
                ${event.extendedProps.instrucciones ? `<p><strong>Instrucciones:</strong> ${event.extendedProps.instrucciones}</p>` : ''}
                ${event.extendedProps.ponderacion ? `<p><strong>Ponderaci√≥n:</strong> ${event.extendedProps.ponderacion}%</p>` : ''}
                ${event.extendedProps.prioridad ? `<p><strong>Prioridad:</strong> <span class="badge ${event.extendedProps.prioridad === 'URGENTE' ? 'bg-danger' : event.extendedProps.prioridad === 'ALTA' ? 'bg-warning' : 'bg-info'}">${event.extendedProps.prioridad}</span></p>` : ''}
                ${event.extendedProps.encargado ? `<p><strong>Encargado:</strong> ${event.extendedProps.encargado}</p>` : ''}
                ${event.extendedProps.motivo ? `<p><strong>Motivo:</strong> ${event.extendedProps.motivo}</p>` : ''}
            </div>
        `;
        
        // Crear un modal din√°mico para mostrar detalles
        var modalHtml = `
            <div class="modal fade" id="modalEventDetails" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header ${getEventBg(event.extendedProps.type)} text-white">
                            <h5 class="modal-title">Detalles del Evento</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal anterior si existe
        var existingModal = document.getElementById('modalEventDetails');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Agregar nuevo modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        var modal = new bootstrap.Modal(document.getElementById('modalEventDetails'));
        modal.show();
        
        // Limpiar modal despu√©s de cerrarlo
        document.getElementById('modalEventDetails').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // Mapeo de horarios por bloques
    var horariosBloques = {
        '1': { inicio: '08:00', fin: '08:45' },
        '2': { inicio: '08:45', fin: '09:30' },
        '3': { inicio: '09:45', fin: '10:30' },
        '4': { inicio: '10:30', fin: '11:15' },
        '5': { inicio: '11:30', fin: '12:15' },
        '6': { inicio: '12:15', fin: '13:00' },
        '7': { inicio: '13:45', fin: '14:30' },
        '8': { inicio: '14:30', fin: '15:15' },
        '9': { inicio: '15:15', fin: '16:00' }
    };

    // Funci√≥n para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funci√≥n para actualizar campos seg√∫n tipo de evento
    window.updateEventTypeFields = function() {
        var tipo = document.getElementById('tipo-evento').value;
        var campoMateriales = document.getElementById('campo-materiales');
        var camposEvaluacion = document.getElementById('campos-evaluacion');
        var asignaturaRequired = document.getElementById('asignatura-required');
        var selectAsignatura = document.getElementById('asignatura-evento');
        var ubicacionField = document.getElementById('ubicacion-evento');
        
        // Resetear visibilidad
        campoMateriales.style.display = 'none';
        camposEvaluacion.style.display = 'none';
        asignaturaRequired.style.display = 'none';
        selectAsignatura.required = false;
        
        // Resetear ubicaci√≥n
        ubicacionField.readOnly = false;
        ubicacionField.value = '';
        
        // Mostrar campos espec√≠ficos seg√∫n tipo
        switch(tipo) {
            case 'MATERIAL':
            case 'TAREA':
                campoMateriales.style.display = 'block';
                break;
            case 'EVALUACION':
                camposEvaluacion.style.display = 'block';
                asignaturaRequired.style.display = 'inline';
                selectAsignatura.required = true;
                break;
            case 'CANCELAR_CLASE':
                asignaturaRequired.style.display = 'inline';
                selectAsignatura.required = true;
                break;
        }
        
        // Actualizar fechas disponibles si hay asignatura seleccionada
        updateFechasDisponibles();
    };

    // Funci√≥n para actualizar fechas disponibles seg√∫n la asignatura seleccionada
    function updateFechasDisponibles() {
        var selectAsignatura = document.getElementById('asignatura-evento');
        var selectFecha = document.getElementById('fecha-evento');
        var cursoInfo = document.getElementById('curso-info-evento');
        var ubicacionField = document.getElementById('ubicacion-evento');
        
        // Limpiar fechas
        selectFecha.innerHTML = '<option value="">Selecciona una fecha</option>';
        selectFecha.disabled = true;
        
        // Limpiar curso info y ubicaci√≥n
        cursoInfo.value = '';
        ubicacionField.value = '';
        
        var asignaturaId = selectAsignatura.value;
        if (!asignaturaId) {
            selectFecha.innerHTML = '<option value="">Selecciona una asignatura primero</option>';
            return;
        }
        
        // Limpiar curso temporalmente
        document.getElementById('curso-info-evento').value = 'Cargando...';
        
        // Hacer petici√≥n AJAX para obtener horarios espec√≠ficos de la asignatura
        fetch(`/obtener-horarios-asignatura/${asignaturaId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var horarios = data.horarios;
                var diasUnicos = [...new Set(horarios.map(h => h.dia))];
                
                // Auto-completar curso desde el backend
                if (horarios.length > 0) {
                    document.getElementById('curso-info-evento').value = horarios[0].curso;
                } else {
                    document.getElementById('curso-info-evento').value = 'Sin curso asignado';
                }
                
                // Obtener la sala principal de la asignatura
                if (horarios.length > 0) {
                    ubicacionField.value = horarios[0].sala;
                    ubicacionField.readOnly = true;
                }
                
                // Generar fechas para las pr√≥ximas 4 semanas solo para d√≠as v√°lidos
                var hoy = new Date();
                
                for (var i = 0; i < 28; i++) { // 4 semanas
                    var fecha = new Date(hoy);
                    fecha.setDate(hoy.getDate() + i);
                    
                    var diaSemana = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'][fecha.getDay()];
                    
                    // Solo mostrar d√≠as donde se imparte la asignatura
                    if (diasUnicos.includes(diaSemana)) {
                        var fechaStr = fecha.toISOString().split('T')[0];
                        var fechaDisplay = fecha.toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            day: 'numeric', 
                            month: 'long' 
                        });
                        
                        var option = document.createElement('option');
                        option.value = fechaStr;
                        option.textContent = fechaDisplay;
                        option.setAttribute('data-dia', diaSemana);
                        selectFecha.appendChild(option);
                    }
                }
                
                selectFecha.disabled = false;
                
                // Guardar horarios para uso posterior
                selectFecha.setAttribute('data-horarios', JSON.stringify(horarios));
                         } else {
                alert('Error al obtener horarios de la asignatura');
                document.getElementById('curso-info-evento').value = 'Error al cargar';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('curso-info-evento').value = 'Error de conexi√≥n';
            
            // Fallback: mostrar d√≠as laborales gen√©ricos
            var diasSemana = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES'];
            var hoy = new Date();
            
            for (var i = 0; i < 28; i++) {
                var fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                
                var diaSemana = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'][fecha.getDay()];
                
                if (diasSemana.includes(diaSemana)) {
                    var fechaStr = fecha.toISOString().split('T')[0];
                    var fechaDisplay = fecha.toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long' 
                    });
                    
                    var option = document.createElement('option');
                    option.value = fechaStr;
                    option.textContent = fechaDisplay;
                    option.setAttribute('data-dia', diaSemana);
                    selectFecha.appendChild(option);
                }
            }
            
            selectFecha.disabled = false;
        });
    }
    
    // Funci√≥n para actualizar bloques disponibles seg√∫n la fecha seleccionada
    function updateBloquesDisponibles() {
        var selectAsignatura = document.getElementById('asignatura-evento');
        var selectFecha = document.getElementById('fecha-evento');
        var selectBloque = document.getElementById('bloque-evento');
        
        // Limpiar bloques
        selectBloque.innerHTML = '<option value="">Selecciona un bloque</option>';
        selectBloque.disabled = true;
        
        var asignaturaId = selectAsignatura.value;
        var fechaSeleccionada = selectFecha.value;
        
        if (!asignaturaId || !fechaSeleccionada) {
            selectBloque.innerHTML = '<option value="">Selecciona una fecha primero</option>';
            return;
        }
        
        // Obtener d√≠a de la semana de la fecha seleccionada
        var option = selectFecha.querySelector('option:checked');
        var diaSemana = option.getAttribute('data-dia');
        
        // Obtener horarios guardados de la asignatura
        var horariosData = selectFecha.getAttribute('data-horarios');
        if (!horariosData) {
            selectBloque.innerHTML = '<option value="">Error: No se pudieron cargar los horarios</option>';
            return;
        }
        
        try {
            var horarios = JSON.parse(horariosData);
            
            // Filtrar horarios para el d√≠a seleccionado
            var horariosDelDia = horarios.filter(h => h.dia === diaSemana);
            
            if (horariosDelDia.length === 0) {
                selectBloque.innerHTML = '<option value="">No hay clases este d√≠a</option>';
                return;
            }
            
            // Agrupar bloques consecutivos
            var bloquesUsados = horariosDelDia.map(h => parseInt(h.bloque)).sort((a, b) => a - b);
            var bloquesAgrupados = [];
            var bloquesEnGrupo = new Set();
            
            // Detectar bloques consecutivos (pares)
            for (var i = 0; i < bloquesUsados.length - 1; i++) {
                var bloqueActual = bloquesUsados[i];
                var bloqueSiguiente = bloquesUsados[i + 1];
                
                // Si son consecutivos
                if (bloqueSiguiente === bloqueActual + 1 && !bloquesEnGrupo.has(bloqueActual)) {
                    var inicioHora = horariosBloques[bloqueActual].inicio;
                    var finHora = horariosBloques[bloqueSiguiente].fin;
                    
                    bloquesAgrupados.push({
                        value: inicioHora + '-' + finHora,
                        text: `Bloques ${bloqueActual}-${bloqueSiguiente} (${inicioHora} - ${finHora})`,
                        bloques: [bloqueActual, bloqueSiguiente]
                    });
                    
                    bloquesEnGrupo.add(bloqueActual);
                    bloquesEnGrupo.add(bloqueSiguiente);
                }
            }
            
            // Agregar bloques individuales que no son parte de pares
            bloquesUsados.forEach(bloque => {
                if (!bloquesEnGrupo.has(bloque)) {
                    var inicioHora = horariosBloques[bloque].inicio;
                    var finHora = horariosBloques[bloque].fin;
                    
                    bloquesAgrupados.push({
                        value: inicioHora + '-' + finHora,
                        text: `Bloque ${bloque} (${inicioHora} - ${finHora})`,
                        bloques: [bloque]
                    });
                }
            });
            
            // Ordenar por primer bloque
            bloquesAgrupados.sort((a, b) => Math.min(...a.bloques) - Math.min(...b.bloques));
            
            // Agregar opciones al select
            bloquesAgrupados.forEach(bloque => {
                var option = document.createElement('option');
                option.value = bloque.value;
                option.textContent = bloque.text;
                selectBloque.appendChild(option);
            });
            
            selectBloque.disabled = false;
            
        } catch (error) {
            console.error('Error al procesar horarios:', error);
            selectBloque.innerHTML = '<option value="">Error al cargar bloques</option>';
        }
    }
    


    // Evitar duplicaci√≥n de event listeners
    function setupEventListeners() {
        var asignaturaSelect = document.getElementById('asignatura-evento');
        var fechaSelect = document.getElementById('fecha-evento');
        
        // Remover listeners existentes
        asignaturaSelect.removeEventListener('change', updateFechasDisponibles);
        fechaSelect.removeEventListener('change', updateBloquesDisponibles);
        
        // Agregar listeners
        asignaturaSelect.addEventListener('change', updateFechasDisponibles);
        fechaSelect.addEventListener('change', updateBloquesDisponibles);
    }

    // Inicializar calendario cuando se hace clic en la pesta√±a
    if (calendarTab) {
        calendarTab.addEventListener('click', function() {
            setTimeout(() => {
                initializeCalendarGeneral();
                setupEventListeners();
            }, 100);
        });
    }

    // Si la pesta√±a ya est√° activa, inicializar inmediatamente
    if (calendarTab && calendarTab.classList.contains('active')) {
        initializeCalendarGeneral();
        setupEventListeners();
    }

    // Manejar formulario de crear evento
    document.getElementById('form-crear-evento').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = {
            tipo: document.getElementById('tipo-evento').value,
            asignatura_id: document.getElementById('asignatura-evento').value || null,
            titulo: document.getElementById('titulo-evento').value,
            descripcion: document.getElementById('descripcion-evento').value,
            fecha: document.getElementById('fecha-evento').value,
            bloque_horario: document.getElementById('bloque-evento').value,
            ubicacion: document.getElementById('ubicacion-evento').value || null,
            materiales: document.getElementById('materiales-evento').value || null,
            ponderacion: document.getElementById('ponderacion-evento').value || null,
            tipo_evaluacion: document.getElementById('tipo-evaluacion').value || null
        };

        // Validaci√≥n b√°sica
        if (!formData.tipo || !formData.titulo || !formData.fecha) {
            alert('Por favor completa los campos obligatorios');
            return;
        }
        
        // Validaci√≥n espec√≠fica para evaluaciones y cancelaciones
        if (formData.tipo === 'EVALUACION' || formData.tipo === 'CANCELAR_CLASE') {
            if (!formData.asignatura_id) {
                alert('Para ' + (formData.tipo === 'EVALUACION' ? 'evaluaciones' : 'cancelar clases') + ', debes seleccionar una asignatura');
                return;
            }
            if (!formData.bloque_horario) {
                alert('Para ' + (formData.tipo === 'EVALUACION' ? 'evaluaciones' : 'cancelar clases') + ', debes seleccionar el bloque/horario');
                return;
            }
        }

        // Mostrar loading
        var submitBtn = document.querySelector('#modalCrearEvento .btn-success');
        var originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
        submitBtn.disabled = true;

        // Debug: mostrar datos que se van a enviar
        console.log('=== DATOS A ENVIAR ===');
        console.log('formData:', formData);
        console.log('URLSearchParams:', new URLSearchParams(formData).toString());
        
        // Enviar datos al backend
        fetch('/crear-evento-calendario/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams(formData)
        })
        .then(response => {
            console.log('=== RESPUESTA RECIBIDA ===');
            console.log('Status:', response.status);
            console.log('Headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('Data:', data);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                alert('‚úÖ ' + data.message);
                bootstrap.Modal.getInstance(document.getElementById('modalCrearEvento')).hide();
                
                // Recargar la p√°gina para mostrar el nuevo evento
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    });



    // Funci√≥n para obtener el CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funciones globales
    window.refreshEventList = function() {
        updateProximosEventos();
    };

    window.clearEventForm = function() {
        document.getElementById('form-crear-evento').reset();
        
        // Resetear campos dependientes
        document.getElementById('fecha-evento').innerHTML = '<option value="">Selecciona una asignatura primero</option>';
        document.getElementById('fecha-evento').disabled = true;
        document.getElementById('bloque-evento').innerHTML = '<option value="">Selecciona una fecha primero</option>';
        document.getElementById('bloque-evento').disabled = true;
        document.getElementById('curso-info-evento').value = '';
        document.getElementById('ubicacion-evento').value = '';
        document.getElementById('ubicacion-evento').readOnly = false;
        
        updateEventTypeFields(); // Resetear campos din√°micos
    };

    // Funci√≥n para editar eventos
    window.editarEvento = function(eventoId, eventData) {
        // Extraer ID real del evento (sin prefijo)
        var realId = eventoId.replace(/^(colegio_|clase_|cancelada_)/, '');
        var eventType = eventoId.includes('colegio_') ? 'colegio' : 'clase';
        
        // Obtener datos del evento desde el backend
        fetch(`/editar-evento-calendario/${realId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var evento = data.evento;
                
                // Llenar el formulario de edici√≥n
                document.getElementById('evento-id-edit').value = realId;
                document.getElementById('evento-type-edit').value = evento.event_type;
                document.getElementById('titulo-evento-edit').value = evento.titulo;
                document.getElementById('fecha-evento-edit').value = evento.fecha;
                document.getElementById('descripcion-evento-edit').value = evento.descripcion;
                document.getElementById('ubicacion-evento-edit').value = evento.ubicacion || '';
                
                // Mostrar campos espec√≠ficos
                if (evento.event_type === 'clase') {
                    document.getElementById('campo-materiales-edit').style.display = 'block';
                    document.getElementById('materiales-evento-edit').value = evento.materiales || '';
                    document.getElementById('campo-ubicacion-edit').style.display = 'none';
                } else {
                    document.getElementById('campo-materiales-edit').style.display = 'none';
                    document.getElementById('campo-ubicacion-edit').style.display = 'block';
                }
                
                // Mostrar modal
                var modal = new bootstrap.Modal(document.getElementById('modalEditarEvento'));
                modal.show();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del evento');
        });
    };

    // Funci√≥n para eliminar eventos
    window.eliminarEvento = function(eventoId, titulo, eventData) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar el evento "${titulo}"?`)) {
            return;
        }
        
        // Extraer ID real del evento (sin prefijo)
        var realId = eventoId.replace(/^(colegio_|clase_|cancelada_)/, '');
        var eventType = eventoId.includes('colegio_') ? 'colegio' : 'clase';
        
        fetch(`/eliminar-evento-calendario/${realId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                'event_type': eventType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                location.reload(); // Recargar para actualizar la lista
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar el evento');
        });
    };

    // Manejar formulario de editar evento
    document.getElementById('form-editar-evento').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var eventoId = document.getElementById('evento-id-edit').value;
        var eventType = document.getElementById('evento-type-edit').value;
        
        var formData = {
            titulo: document.getElementById('titulo-evento-edit').value,
            fecha: document.getElementById('fecha-evento-edit').value,
            descripcion: document.getElementById('descripcion-evento-edit').value,
            event_type: eventType
        };
        
        if (eventType === 'clase') {
            formData.materiales = document.getElementById('materiales-evento-edit').value;
        } else {
            formData.ubicacion = document.getElementById('ubicacion-evento-edit').value;
        }
        
        var submitBtn = document.querySelector('#modalEditarEvento .btn-info');
        var originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        submitBtn.disabled = true;
        
        fetch(`/editar-evento-calendario/${eventoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams(formData)
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                alert('‚úÖ ' + data.message);
                bootstrap.Modal.getInstance(document.getElementById('modalEditarEvento')).hide();
                location.reload(); // Recargar para mostrar cambios
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            console.error('Error:', error);
            alert('‚ùå Error al guardar los cambios');
        });
    });
});
</script> 